From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Andreas Dinter <andreas.dinter@systec-electronic.com>
Date: Thu, 1 Aug 2024 13:41:37 +0200
Subject: [PATCH] board/ti/am62x/sysworxx.c: Reset ethernet phys during startup

Signed-off-by: Andreas Dinter <andreas.dinter@systec-electronic.com>
---
 board/ti/am62x/sysworxx.c                     | 37 +++++++++++++++++++
 configs/am625_sysworxx_a53.config             |  1 +
 dts/upstream/src/arm64/ti/k3-am625-sk.dts     |  7 +---
 .../src/arm64/ti/k3-am62x-sk-common.dtsi      |  9 ++---
 4 files changed, 44 insertions(+), 10 deletions(-)

diff --git a/board/ti/am62x/sysworxx.c b/board/ti/am62x/sysworxx.c
index 86f30c8b9ee..aa754e4722b 100644
--- a/board/ti/am62x/sysworxx.c
+++ b/board/ti/am62x/sysworxx.c
@@ -21,6 +21,8 @@
 #include <asm/arch/hardware.h>
 #include <dm/uclass.h>
 #include <asm/arch/k3-ddr.h>
+#include <asm/gpio.h>
+#include <linux/delay.h>
 
 #include "../common/fdt_ops.h"
 
@@ -87,6 +89,41 @@ int board_init(void)
 	return 0;
 }
 
+#if defined(CONFIG_RESET_PHY_R)
+void reset_eth_phy(const char* phy_rst_name) {
+	int ret;
+	struct gpio_desc phy_rst_desc;
+
+	ret = dm_gpio_lookup_name(phy_rst_name, &phy_rst_desc);
+	if (ret) {
+		printf("gpio not found: %s\n", phy_rst_name);
+		goto err;
+	}
+
+	ret = dm_gpio_request(&phy_rst_desc, "phy reset");
+	if (ret) {
+		printf("requesting gpio: %s failed\n", phy_rst_name);
+		goto err;
+	}
+
+	dm_gpio_set_dir_flags(&phy_rst_desc, GPIOD_IS_OUT);
+	udelay(10);
+	dm_gpio_set_value(&phy_rst_desc, 0);
+	udelay(10000);
+	dm_gpio_set_value(&phy_rst_desc, 1);
+
+err:
+	return;
+}
+
+void reset_phy(void) {
+	printf("reset ethernet PHY0\n");
+	reset_eth_phy("gpio@601000_15");
+	printf("reset ethernet PHY1\n");
+	reset_eth_phy("gpio@601000_29");
+}
+#endif
+
 #ifdef CONFIG_BOARD_LATE_INIT
 int board_late_init(void)
 {
diff --git a/configs/am625_sysworxx_a53.config b/configs/am625_sysworxx_a53.config
index a07a69ade7e..6af840a78c5 100644
--- a/configs/am625_sysworxx_a53.config
+++ b/configs/am625_sysworxx_a53.config
@@ -2,3 +2,4 @@
 
 CONFIG_TARGET_SYSWORXX_AM62X_ADOPT=y
 CONFIG_ENV_SOURCE_FILE="sysworxx"
+CONFIG_RESET_PHY_R=y
diff --git a/dts/upstream/src/arm64/ti/k3-am625-sk.dts b/dts/upstream/src/arm64/ti/k3-am625-sk.dts
index f3534338b41..fd797eb5186 100644
--- a/dts/upstream/src/arm64/ti/k3-am625-sk.dts
+++ b/dts/upstream/src/arm64/ti/k3-am625-sk.dts
@@ -178,11 +178,8 @@
 };
 
 &cpsw3g_mdio {
-	cpsw3g_phy1: ethernet-phy@1 {
-		reg = <1>;
-		ti,rx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
-		ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
-		ti,min-output-impedance;
+	cpsw3g_phy1: ethernet-phy@3 {
+		reg = <3>;
 	};
 };
 
diff --git a/dts/upstream/src/arm64/ti/k3-am62x-sk-common.dtsi b/dts/upstream/src/arm64/ti/k3-am62x-sk-common.dtsi
index 8e79fc23998..f9cf0edeefd 100644
--- a/dts/upstream/src/arm64/ti/k3-am62x-sk-common.dtsi
+++ b/dts/upstream/src/arm64/ti/k3-am62x-sk-common.dtsi
@@ -281,6 +281,8 @@
 		pinctrl-single,pins = <
 			AM62X_IOPAD(0x160, PIN_OUTPUT, 0) /* (AD24/V17) MDIO0_MDC */
 			AM62X_IOPAD(0x15c, PIN_INPUT, 0) /* (AB22/U16) MDIO0_MDIO */
+			AM62X_IOPAD(0x01b4, PIN_OUTPUT_PULLUP, 7) /* (A13) SPI0_CS0.GPIO1_15 */
+			AM62X_IOPAD(0x01ec, PIN_OUTPUT_PULLUP, 7) /* (A17) I2C1_SDA.GPIO1_29 */
 		>;
 	};
 
@@ -530,12 +532,9 @@
 	pinctrl-names = "default";
 	pinctrl-0 = <&main_mdio1_pins_default>;
 
-	cpsw3g_phy0: ethernet-phy@0 {
+	cpsw3g_phy0: ethernet-phy@1 {
 		bootph-all;
-		reg = <0>;
-		ti,rx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
-		ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
-		ti,min-output-impedance;
+		reg = <1>;
 	};
 };
 
-- 
2.50.1

